{#
Copyright 2015 Sébastien Maccagnoni-Munch

This file is part of AwesomeShop.

AwesomeShop is free software: you can redistribute it and/or modify it under
the terms of the GNU Affero General Public License as published by the
Free Software Foundation, either version 3 of the License, or (at your
option) any later version.

AwesomeShop is distributed in the hope that it will be useful, but WITHOUT
ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE. See the GNU Affero General Public License for more
details.

You should have received a copy of the GNU Affero General Public License
along with AwesomeShop. If not, see <http://www.gnu.org/licenses/>.
#}
{% extends "skeleton.html" %}

{% block title %}{{ _('Checkout') }}{% endblock %}
{% block content %}
{%- if cart %}
<form method="POST" action="{{ url_for('confirm_order') }}" id="checkout-form">
    <h1>{{ _('Checkout') }}</h1>
    <div class="panel panel-default">
        <div class="panel-heading">
            <div class="row">
                <div class="col-sm-6">
                    <i class="fa fa-cube"></i>
                    {{ _('Product') }}
                </div>
                <div class="col-xs-4 col-sm-2 text-right">
                    {{ _('Qty') }}
                </div>
                <div class="col-xs-4 col-sm-2 text-right">
                    {{ _('Unit') }}
                </div>
                <div class="col-xs-4 col-sm-2 text-right">
                    {{ _('Total') }}
                </div>
            </div>
        </div>
        <div class="list-group">
            {%- for line in cart %}
            <div class="list-group-item">
                <div class="row">
                    <div class="col-sm-6">
                        {{ line.get_full_name() }}
                    </div>
                    <div class="col-xs-4 col-sm-2 text-right">
                        {{ line.quantity }}
                    </div>
                    <div class="col-xs-4 col-sm-2 text-right">
                        {{ line.get_price_per_item().quantize('0.01').net }} {{ config.CURRENCY }}
                    </div>
                    <div class="col-xs-4 col-sm-2 text-right">
                        <strong>
                            {{ line.get_total().quantize('0.01').net }} {{ config.CURRENCY }}
                        </strong>
                    </div>
                 </div>
            </div>
            {%- endfor %}
            {%- if cart_modified_because_of_stock %}
            <div class="list-group-item">
                <b class="text-danger">{{ _('Your cart has been modified because stock is insufficient for one or more products.') }}</b>
            </div>
            {%- endif %}
            {%- if cart.stock_status == 'on_demand' %}
            <div class="list-group-item">
                <b class="text-danger">{{ _('Your cart contains products to be ordered on demand. Shipping will be delayed for %(min)d-%(max)d days.', min=config.ON_DEMAND_DELAY_MIN, max=config.ON_DEMAND_DELAY_MAX) }}</b>
            </div>
            {%- endif %}
        </div>
    </div>
    {%- if current_user.addresses %}
    <div class="row checkout-addresses">
        <div class="col-md-6">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">
                        <i class="fa fa-map-marker"></i>
                        {{ _('Delivery address') }}
                    </h3>
                </div>
                <div class="panel-body">
                    <div class="form-group">
                        <select id="delivery-select" class="form-control" name="delivery" onchange="update_delivery_address()">
                            {%- for address in current_user.addresses %}
                            <option value="{{ address.id }}"{% if address.id|string == current_user.latest_delivery_address %} selected="selected"{% endif %}>{{ address.title }}</option>
                            {%- endfor %}
                        </select>
                    </div>
                    <p>{{ _('The package will be shipped to:') }}</p>
                    <div class="delivery-display">
                        <pre class="well" id="delivery-address"></pre>
                        <div class="btn-group btn-group-justified">
                            <a href="#" class="btn btn-info" id="delivery-modify-address">
                                <i class="fa fa-pencil"></i>
                                {{ _('Modify') }}
                            </a>
                            <a href="{{ url_for('address_from_checkout', address_destination='delivery') }}" class="btn btn-warning" onclick="sessionStorage.removeItem('delivery-address')">
                                <i class="fa fa-plus"></i>
                                {{ _('New address') }}
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">
                        <i class="fa fa-file-text-o"></i>
                        {{ _('Billing address') }}
                    </h3>
                </div>
                <div class="panel-body">
                    <div id="billing-checkbox" class="checkbox">
                        <label>
                            <input type="checkbox"{% if current_user.latest_delivery_as_billing %} checked="checked"{% endif %} name="delivery_as_billing" id="delivery-as-billing" onchange="change_delivery_as_billing()">
                            {{ _('Use the delivery address') }}
                        </label> 
                    </div>
                    <div id="billing-container" class="hidden">
                        <div class="form-group">
                            <select id="billing-select" class="form-control" name="billing" onchange="update_billing_address()">
                                {%- for address in current_user.addresses %}
                                <option value="{{ address.id }}"{% if address.id|string == current_user.latest_billing_address %} selected="selected"{% endif %}>{{ address.title }}</option>
                                {%- endfor %}
                            </select>
                        </div>
                        <div class="delivery-display">
                            <pre class="well" id="billing-address"></pre>
                            <div class="btn-group btn-group-justified">
                                <a href="#" class="btn btn-info" id="billing-modify-address">
                                    <i class="fa fa-pencil"></i>
                                    {{ _('Modify') }}
                                </a>
                                <a href="{{ url_for('address_from_checkout', address_destination='billing') }}" class="btn btn-warning" onclick="sessionStorage.removeItem('billing-address')">
                                    <i class="fa fa-plus"></i>
                                    {{ _('New address') }}
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="panel panel-default">
        <div class="panel-heading">
            <h2 class="panel-title">
                <i class="fa fa-truck"></i>
                {{ _('Shipping') }}
            </h2>
        </div>
        <div class="list-group order-options" id="carriers-list">
        </div>
    </div>
    {%- else -%}
    <div class="panel panel-default">
        <div class="panel-body">
            <p class="lead text-center">{{ _('You must define at least one address for delivery') }}</p>
            <a href="{{ url_for('address_from_checkout', address_destination='delivery') }}" class="btn btn-lg btn-block btn-success">
                <i class="fa fa-home"></i>
                {{ _('Create an address') }}
            </a>
        </div>
    </div>
    {%- endif %}
    <div class="well">
        <div class="row">
            <div class="col-xs-8 col-md-9 text-right">
                {{ _('Subtotal') }}
            </div>
            <div class="col-xs-4 col-md-3 text-right">
                {{ cart.get_total().quantize('0.01').net }} {{ config.CURRENCY }}
            </div>
        </div>
        <div class="shippingtotal">
            <div class="row">
                <div class="col-xs-8 col-md-9 text-right">
                    {{ _('Shipping fee') }}
                </div>
                <div class="col-xs-4 col-md-3 text-right" id="shipping-fee">
                </div>
            </div>
            <div class="row total-cost text-info">
                <div class="col-xs-8 col-md-9 text-right">
                    {{ _('Total') }}
                </div>
                <div class="col-xs-4 col-md-3 text-right">
                    <b id="total">
                    </b>
                </div>
            </div>
        </div>
    </div>
    <div class="panel panel-default">
        <div class="panel-heading">
            <h2 class="panel-title">
                <i class="fa fa-money"></i>
                {{_('Payment') }}
            </h2>
        </div>
        <div class="list-group order-options">
            {%- for mode in modes_of_payment %}
            <label class="list-group-item">
                <input type="radio" name="payment" value="{{ mode.id }}"{% if mode.id|string == current_user.latest_payment %} checked="checked"{% endif %} onchange="payment_changed('{{ mode.id }}')">
                {{ mode.text|safe }}
            </label>
            {% endfor %}
        </div>
    </div>
    <textarea placeholder="{{ _('If you have any message for us about this order, write it here!') }}" id="checkout-message" class="form-control"></textarea>
    <div class="panel panel-default">
        <div class="panel-body text-right">
            <label class="reused-package">
                <i class="fa fa-recycle"></i>
                {{ _('I accept that my order is shipped in a reused package') }}
                <input type="checkbox" name="reused_package"{% if current_user.latest_reused_package %} checked="checked"{% endif %} onclick="save_reused_package_status()">
            </label>
            <label>
                <i class="fa fa-check"></i>
                <b>{{ _('I agree to the %(terms)s and adhere to them unconditionally', terms='<a href="'|safe+url_for('info', slug='terms_of_purchase')+'" target="_blank">'|safe+_('terms of purchase')+'</a>'|safe) }}</b>
                <input type="checkbox" name="accept_terms" onchange="maybe_activate_payment_button()">
            </label>
            {%- if cart.stock_status == 'on_demand' %}
            <br>
            <b class="text-danger">{{ _('I understand that the cart contains products to be ordered on demand and that shipping will be delayed for %(min)d-%(max)d days.', min=config.ON_DEMAND_DELAY_MIN, max=config.ON_DEMAND_DELAY_MAX) }}</b>
            {%- endif %}
        </div>
    </div>
    <button type="submit" id="proceed" class="btn btn-lg btn-success pull-right" disabled="disabled">
        {{ _('Verify and confirm the order') }}
        <i class="fa fa-chevron-right"></i>
    </button>
    <small>{{ _('TVA non applicable, article 293 B du Code général des impôts') }}</small>
</form>
<script>
var addresses = {
        {%- for address in current_user.addresses %}
        "{{ address.id }}": {
            address: "{{ address.firstname }} {{ address.lastname }}\n{{ address.address|replace('\n','\\n')|replace('\r', '') }}\n{{ address.country }}",
            modifyurl: "{{ url_for('address_from_checkout', address_id=address.id) }}",
            carriers: [
                {%- for carrier in address.carriers(weight=cart.weight()) %}
                {
                    name: "{{ carrier[0] }}",
                    id: "{{ carrier[0].id }}",
                    gross: "{{ carrier[1].gross }} {{ config.CURRENCY }}",
                    net: "{{ carrier[1].net }} {{ config.CURRENCY }}",
                    total_net: "{{ carrier[1].net + cart.get_total().quantize('0.01').net }} {{ config.CURRENCY }}"
                    },
            {%- endfor %}
                ]
            },
        {%- endfor %}
        };
function update_delivery_address() {
    var id = document.getElementById('delivery-select').value,
        address = addresses[id],
        carriers_list = document.getElementById('carriers-list');
    // Display the delivery address
    document.getElementById('delivery-address').innerHTML = address.address;
    document.getElementById('delivery-modify-address').href = address.modifyurl;
    // Save the address in the session
    sessionStorage.setItem('delivery-address', id);
    // Remove all carriers options
    while (carriers_list.firstChild) {
        carriers_list.removeChild(carriers_list.firstChild);
    };
    // Reinitialize the price display
    document.getElementById('shipping-fee').innerHTML = "...";
    document.getElementById('total').innerHTML = "...";
    // Create new carriers options
    address.carriers.forEach(function(c){
        var label = document.createElement('label');
        label.className = "list-group-item";
        var row = document.createElement('div');
        row.className = "row";
        var col1 = document.createElement('div');
        col1.className = "col-xs-8";
        var radio = document.createElement('input');
        radio.type = "radio";
        radio.name = "shipping";
        radio.value = c.id;
        radio.setAttribute('onchange', "carrier_changed('"+c.net+"', '"+c.total_net+"', '"+c.id+"')");
        if (c.id == '{{ current_user.latest_carrier }}') {
            radio.setAttribute('checked', 'checked');
            document.getElementById('shipping-fee').innerHTML = c.net;
            document.getElementById('total').innerHTML = c.total_net;
        };
        var name = document.createElement('span');
        name.innerHTML = c.name;
        var col2 = document.createElement('div');
        col2.className = "col-xs-4 text-right";
        var cost = document.createElement('b');
        cost.innerHTML = c.net;
        col2.appendChild(cost);
        col1.appendChild(radio);
        col1.appendChild(name);
        row.appendChild(col1);
        row.appendChild(col2);
        label.appendChild(row);
        carriers_list.appendChild(label);
    });
    maybe_activate_payment_button();
}
function update_billing_address() {
    var id=document.getElementById('billing-select').value;
    // Display the billing address
    document.getElementById('billing-address').innerHTML = addresses[id].address;
    document.getElementById('billing-modify-address').href = addresses[id].modifyurl;
    // Save the address in the session
    sessionStorage.setItem('billing-address', id);
}
function change_delivery_as_billing() {
    var cont = document.getElementById('billing-container'),
        checked = document.getElementById('delivery-as-billing').checked;
    if (checked == true) {
        cont.className="hidden";
    } else {
        cont.className="";
    };
    sessionStorage.setItem('delivery-as-billing', checked);
}
function carrier_changed(net, total_net, id) {
    document.getElementById('shipping-fee').innerHTML = net;
    document.getElementById('total').innerHTML = total_net;
    sessionStorage.setItem('carrier', id);
    maybe_activate_payment_button();
}
function payment_changed(id) {
    sessionStorage.setItem('payment', id);
    maybe_activate_payment_button();
}
function save_reused_package_status() {
    sessionStorage.setItem(
            'reused-package', 
            document.getElementById('checkout-form').reused_package.checked
            );
}
function maybe_activate_payment_button() {
    var form = document.getElementById('checkout-form');
    if (form['delivery'].value && form['shipping'].value &&
        form['payment'].value && form['accept_terms'].checked) {
        document.getElementById('proceed').disabled = "";
    } else {;
        document.getElementById('proceed').disabled = "disabled";
    };
}
function initialize() {
    // Get data from the session (to keep recent changes)
    delivery = sessionStorage.getItem('delivery-address');
    if (delivery) {
        document.getElementById('delivery-select').value = delivery;
    };
    delivery_as_billing = sessionStorage.getItem('delivery-as-billing');
    if (delivery_as_billing) {
        var checkbox = document.getElementById('delivery-as-billing');
        if (delivery_as_billing == "true") {
            checkbox.checked = "checked";
        } else if (delivery_as_billing == "false") {
            checkbox.checked = "";
        }
    }
    billing = sessionStorage.getItem('billing-address');
    if (billing) {
        document.getElementById('billing-select').value = billing;
    };
    payment = sessionStorage.getItem('payment');
    if (payment) {
        document.getElementById('checkout-form').payment.value = payment;
    };
    update_delivery_address();
    // Carrier must be changed after updating the delivery address, or the
    // value from the database overrides the value from the session
    //
    // TODO: set the carrier from the session... harder than initially planned
    // carrier = sessionStorage.getItem('carrier');
    update_billing_address();
    change_delivery_as_billing();
    reused = sessionStorage.getItem('reused-package');
    if (reused) {
        var checkbox = document.getElementById('checkout-form').reused_package;
        if (reused == "true") {
            checkbox.checked = "checked";
        } else if (reused == "false") {
            checkbox.checked = "";
        };
    }
    maybe_activate_payment_button();
}
// Initialize everything after loading the page
initialize();
</script>
{%- else -%}
<div class="alert alert-danger text-center">{{ _('Your cart is empty!') }}</div>
{%- endif %}
{%- endblock %}

